# 동시성 이슈 보고서

## 문제 식별

1. 선착순 쿠폰 발급 
    - 여러 명이 동시에 접근 할 경우 총 쿠폰 수 보다 많은 개수의 쿠폰이 발행 되는 문제
2. 상품 주문 재고 불일치
    - 한 상품에 동시에 여러 주문이 발생 할 경우 해당 상품 재고 수량에 대한 정확성이 떨어지는 문제
3. 결제 잔액 불일치
    - 한 사용자가 동시에 여러 결제를 시도 할 경우 해당 사용자의 잔액에 대한 정확성이 떨어지는 문제
4. 동일한 쿠폰 사용
    - 한 사용자가 동일한 쿠폰을 한 번에 여러 번 사용하는 문제

## 분석

1. 선착순 쿠폰 발급
    - 선착순 쿠폰 발급이 동시 접근 제어 없이 처리되어 여러 명의 사용자가 동일한 쿠폰 수량을 조회하게 되는 경우 발생, 그에 따라 계획했던 총 쿠폰 수량보다 많은 수량의 쿠폰이 발급 될 수 있음.
2. 상품 주문 재고 불일치
    - 이벤트 혹은 인기 상품의 경우 한 상품에 여러 명의 사용자가 동시에 주문을 하는 경우 여러 명의 사용자가 동일한 상품 재고를 조회하면서 실제 재고 보다 많은 상품이 주문 될 수 있음.
3. 결제 잔액 불일치
    - 한 사용자가 동시에 여러 결제를 시도할 경우 마지막 결제 기준으로 보유 잔액이 수정되어 총 결제 되어야 할 금액 대비 적은 금액이 결제 될 수 있음.
4. 동일한 쿠폰 사용
    - 한 사용자가 여러 주문을 시도하면서 하나의 쿠폰을 여러 번 사용하려는 경우 하나의 쿠폰으로 더 많은 할인을 받게 될 수 있음.

## 해결

1. 선착순 쿠폰 발급 → 비관적 락 적용
    - 선착순 쿠폰의 경우 총 수량 제한이 있는 이벤트 성 기능이기 때문에 여러 명의 사용자가 동시에 접근 할 가능성이 높고, 선착순 순서를 보장해야 하기 때문에 비관적 락을 사용해서 먼저 쿠폰 발급을 시도한 사용자의 발급 처리가 끝날 때 까지 다른 사용자는 쿠폰 발급을 대기하도록 처리.
    - 쿠폰 발급 로직 실행 시 @Lock 어노테이션 사용한 쿠폰 조회 메서드 사용하여 DB Lock 적용
    
    ```java
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("select c from Coupon c where c.id = :id")
    Optional<Coupon> findByIdForUpdate(@Param("id") Long couponId);
    ```
    
    - 락 적용 전 100개 스레드 동시 시도 결과 쿠폰 발급 개수 34개 반환 → 락 적용 후 쿠폰 발급 개수 100개 반환
2. 상품 재고 → 비관적 락 적용
    - 하나의 상품에 여러 명의 사용자가 동시에 주문 하는 경우가 많지 않을 것 이라고 판단하여 최초 낙관적 락 사용을 생각하였으나, 이벤트 상품 혹은 갑작스럽게 어떤 상품이 인기 상품이 되었을 경우 동시에 다수의 사용자가 주문을 하는 경우가 발생하는 경우가 있을 수 있다고 판단하여 비관적 락 사용
    - 상품 조회 시 @Lock 어노테이션 사용한 상품 조회 메서드 사용하여 DB Lock 적용
    
    ```java
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("select p from Product p where p.id = :id")
    Optional<Product> findByIdForUpdate(@Param("id")Long productId);
    ```
    
    - 락 적용 전 1000개 재고에 3개씩 100개 스레드로 동시 시도 결과 재고 898개 반환 → 락 적용 후 재고 700개 반환
3. 사용자 잔액 → 낙관적 락 적용
    - 일반적으로 한 사용자는 한 번의 결제를 시도하지 여러 결제를 동시에 시도하려는 경우가 많지 않다고 판단하여 낙관적 락을 사용해 여러 결제를 동시해 시도하는 경우 하나의 결제를 제외한 나머지 결제는 취소 처리
    
    ```java
    @Entity
    @Getter
    @NoArgsConstructor
    public class User {
    	@Id
    	@GeneratedValue(strategy = GenerationType.IDENTITY)
    	private Long id;
    	
    	private String name;
    	
    	private int balance;
    	
    	@Version
    	private Long version;
      
      . . .
    }
    ```
    
    - 락 적용 전 3개의 스레드로 동시 시도 결과 결제 실패 0 반환 → 락 적용 후 결제 실패 2개 반환
4. 동일한 쿠폰 사용 → 비관적 락 적용
    - 동일한 쿠폰을 동시에 사용하려는 경우가 많지 않다고 판단하여 낙관적 락을 사용하려고 했으나 선착순 쿠폰 발급에 비관적 락을 사용하였고, 주문 로직에서 재고 차감과 쿠폰 사용이 함께 포함되어있는데 재고 차감이 비관적 락이 적용 되어있기 때문에 비관적 락을 사용하는 것이 맞다고 판단하여 비관적 락 사용
    
    ```java
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("select uc from UserCoupon uc where uc.id = :id")
    Optional<UserCoupon> findByIdForUpdate(@Param("id") Long userCouponId);
    ```
    
    - 락 적용 후 500개 스레드 동시 시도 결과 1회 쿠폰 사용, 499회 쿠폰 사용 실패
